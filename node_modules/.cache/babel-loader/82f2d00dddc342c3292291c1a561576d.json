{"ast":null,"code":"import TempNode from '../core/TempNode.js';\nimport ModelNode from '../accessors/ModelNode.js';\nimport { ShaderNode, dFdx, dFdy, cross, add, mul, max, dot, cond, inversesqrt, equal, normalize, sub, join, positionView, normalView, uv } from '../ShaderNode.js';\nimport { TangentSpaceNormalMap, ObjectSpaceNormalMap } from 'three'; // http://www.thetenthplanet.de/archives/1180\n\nconst perturbNormal2ArbNode = new ShaderNode(inputs => {\n  const {\n    eye_pos,\n    surf_norm,\n    mapN,\n    faceDirection,\n    uv\n  } = inputs;\n  const q0 = dFdx(eye_pos.xyz);\n  const q1 = dFdy(eye_pos.xyz);\n  const st0 = dFdx(uv.st);\n  const st1 = dFdy(uv.st);\n  const N = surf_norm; // normalized\n\n  const q1perp = cross(q1, N);\n  const q0perp = cross(N, q0);\n  const T = add(mul(q1perp, st0.x), mul(q0perp, st1.x));\n  const B = add(mul(q1perp, st0.y), mul(q0perp, st1.y));\n  const det = max(dot(T, T), dot(B, B));\n  const scale = cond(equal(det, 0), 0, mul(faceDirection, inversesqrt(det)));\n  return normalize(add(mul(T, mul(mapN.x, scale)), mul(B, mul(mapN.y, scale)), mul(N, mapN.z)));\n});\n\nclass NormalMapNode extends TempNode {\n  constructor(node) {\n    let scaleNode = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : null;\n    super('vec3');\n    this.node = node;\n    this.scaleNode = scaleNode;\n    this.normalMapType = TangentSpaceNormalMap;\n  }\n\n  generate(builder) {\n    const type = this.getNodeType(builder);\n    const {\n      normalMapType,\n      scaleNode\n    } = this;\n    const normalOP = mul(this.node, 2.0);\n    let normalMap = sub(normalOP, 1.0);\n\n    if (scaleNode !== null) {\n      const normalMapScale = mul(normalMap.xy, scaleNode);\n      normalMap = join(normalMapScale, normalMap.z);\n    }\n\n    if (normalMapType === ObjectSpaceNormalMap) {\n      const vertexNormalNode = mul(new ModelNode(ModelNode.NORMAL_MATRIX), normalMap);\n      const normal = normalize(vertexNormalNode);\n      return normal.build(builder, type);\n    } else if (normalMapType === TangentSpaceNormalMap) {\n      const perturbNormal2ArbCall = perturbNormal2ArbNode({\n        eye_pos: positionView,\n        surf_norm: normalView,\n        mapN: normalMap,\n        faceDirection: 1.0,\n        uv: uv()\n      });\n      return perturbNormal2ArbCall.build(builder, type);\n    }\n  }\n\n}\n\nexport default NormalMapNode;","map":null,"metadata":{},"sourceType":"module"}